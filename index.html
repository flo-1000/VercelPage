<!DOCTYPE html>
<html>
<head>
  <title>Voting App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial;
      max-width: 700px;
      margin: 40px auto;
    }

    input {
      padding: 8px;
      width: 100%;
      margin-bottom: 5px;
    }

    .valid { color: green; }
    .invalid { color: red; }

    .question {
      margin-top: 30px;
      padding: 15px;
      border: 1px solid #ccc;
    }

    button {
      margin-top: 15px;
      padding: 10px;
      width: 100%;
    }
  </style>
</head>
<body>

<h2>Voting App</h2>

<label>Your Name:</label>
<input id="voterInput" list="names">
<span id="voterStatus"></span>

<datalist id="names"></datalist>

<div id="questionsContainer"></div>

<button onclick="submitVotes()">Submit Votes</button>

<script>
  // --------------------------
  // Initialize Supabase client
  // --------------------------
  var supabaseClient = supabase.createClient(
  "https://tnsnitlecyoazswfluzo.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRuc25pdGxlY3lvYXpzd2ZsdXpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTE2NTcsImV4cCI6MjA4NzI4NzY1N30.xarvcLJ0wfUWQ2-oGbv7c-qzfnjYSVzKvMrrjKf1XIw"
);

  var persons = [];
  var questions = [];
  var selectedVotes = {};

  // --------------------------
  // Load persons & questions
  // --------------------------
  async function loadData() {
    const { data: personsData, error: err1 } = await supabaseClient.from("persons").select("*");
    if (err1) { console.error(err1); return; }
    persons = personsData;

    const nameList = document.getElementById("names");
    persons.forEach(p => {
      const option = document.createElement("option");
      option.value = p.name;
      nameList.appendChild(option);
    });

    const { data: questionData, error: err2 } = await supabaseClient.from("questions").select("*");
    if (err2) { console.error(err2); return; }
    questions = questionData;

    const container = document.getElementById("questionsContainer");
    container.innerHTML = "";

    questions.forEach(q => {
      const div = document.createElement("div");
      div.className = "question";
      div.innerHTML = `
        <label>${q.question_text}</label>
        <input list="names" id="q_${q.id}" oninput="validateInput(this, '${q.id}')">
        <span id="status_${q.id}"></span>
      `;
      container.appendChild(div);
    });
  }

  // --------------------------
  // Input validation
  // --------------------------
  window.validateInput = function(input, questionId) {
    const name = input.value.trim();
    const person = persons.find(p => p.name === name);
    const status = document.getElementById("status_" + questionId);

    if (person) {
      status.innerHTML = "✔";
      status.className = "valid";
      selectedVotes[questionId] = person.id;
    } else {
      status.innerHTML = "✖";
      status.className = "invalid";
      delete selectedVotes[questionId];
    }
  }

  document.getElementById("voterInput").addEventListener("input", function() {
    const name = this.value.trim();
    const person = persons.find(p => p.name === name);
    const status = document.getElementById("voterStatus");

    if (person) {
      status.innerHTML = "✔";
      status.className = "valid";
    } else {
      status.innerHTML = "✖";
      status.className = "invalid";
    }
  });

  // --------------------------
  // Submit votes
  // --------------------------
  window.submitVotes = async function() {
    const voterName = document.getElementById("voterInput").value.trim();
    const voter = persons.find(p => p.name === voterName);

    if (!voter) {
      alert("Invalid voter name");
      return;
    }

    if (Object.keys(selectedVotes).length !== questions.length) {
      alert("Answer all questions");
      return;
    }

    for (let q of questions) {
      const targetId = selectedVotes[q.id];

      // Insert vote
      const { error } = await supabaseClient.from("votes").insert({
        voter_id: voter.id,
        target_id: targetId,
        question_id: q.id
      });

      if (error) {
        alert("You already voted for one of the questions or another error occurred.");
        console.error(error);
        return;
      }

      // Increment vote count
      const { error: rpcError } = await supabaseClient.rpc("increment_vote", { person_id: targetId });
      if (rpcError) {
        console.error(rpcError);
      }
    }

    alert("Votes submitted successfully!");
    selectedVotes = {};
    document.getElementById("voterInput").value = "";
    document.getElementById("voterStatus").innerHTML = "";
    loadData(); // reload questions in case you want fresh inputs
  }

  loadData();
</script>

</body>
</html>